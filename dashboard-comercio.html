<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VentaConecta ‚Äî Dashboard Comercio</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--blue:#1a56ff;--blue-light:#4d7aff;--green:#00d68f;--yellow:#ffcc00;--red:#ff4d6d;--dark:#070b14;--dark-2:#0f1623;--dark-3:#1a2235;--card-bg:rgba(255,255,255,0.035);--border:rgba(255,255,255,0.07);--text:#eef2ff;--muted:rgba(238,242,255,0.45);}
body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);display:flex;min-height:100vh;}
.sidebar{width:248px;min-height:100vh;background:var(--dark-2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-head{padding:24px 24px 20px;border-bottom:1px solid var(--border);}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;background:linear-gradient(120deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:16px;}
.sb-user{display:flex;align-items:center;gap:10px;}
.sb-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue-light));display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;color:#fff;flex-shrink:0;}
.sb-name{font-size:13px;font-weight:500;}.sb-role{font-size:11px;color:var(--muted);}
.sb-nav{padding:16px 0;flex:1;}
.sb-section{padding:12px 20px 6px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:var(--muted);cursor:pointer;transition:all 0.18s;text-decoration:none;}
.sb-item:hover{color:var(--text);background:rgba(255,255,255,0.03);}
.sb-item.active{color:var(--text);background:rgba(26,86,255,0.1);border-right:2px solid var(--blue);}
.sb-badge{margin-left:auto;background:var(--yellow);color:#000;border-radius:100px;font-size:10px;font-weight:700;padding:2px 7px;}
.sb-foot{padding:16px 20px;border-top:1px solid var(--border);}
.logout-btn{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:color 0.2s;}
.logout-btn:hover{color:var(--red);}
.main{margin-left:248px;flex:1;padding:32px 36px;}
.topbar{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;letter-spacing:-0.7px;margin-bottom:3px;}
.page-sub{font-size:13px;color:var(--muted);}
.btn-new{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:13.5px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;}
.btn-new:hover{background:var(--blue-light);transform:translateY(-1px);box-shadow:0 8px 28px rgba(26,86,255,0.4);}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.sc{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:22px;position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent);}
.sc-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.sci-b{background:rgba(26,86,255,0.1);border:1px solid rgba(26,86,255,0.18);}
.sci-g{background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.16);}
.sci-y{background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.16);}
.sci-r{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.16);}
.sc-val{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-1px;margin-bottom:3px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.vb{background:linear-gradient(135deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vg{background:linear-gradient(135deg,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vy{background:linear-gradient(135deg,#fff,var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vr{background:linear-gradient(135deg,#fff,#ff8fa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;}
.ni{display:flex;align-items:flex-start;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);transition:background 0.18s;}
.ni:last-child{border-bottom:none;}
.ni:hover{background:rgba(255,255,255,0.02);}
.ndot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.dy{background:var(--yellow);box-shadow:0 0 8px rgba(255,204,0,0.5);}
.dg{background:var(--green);}
.db{background:var(--blue-light);box-shadow:0 0 8px rgba(77,122,255,0.5);}
.dr{background:var(--red);}
.ni-body{flex:1;}
.ni-txt{font-size:13px;line-height:1.5;margin-bottom:3px;}
.ni-meta{font-size:11px;color:var(--muted);margin-top:4px;}
.ni-acts{display:flex;gap:5px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end;align-items:flex-start;padding-top:1px;}
.brecibir{padding:5px 11px;background:rgba(77,122,255,0.1);border:1px solid rgba(77,122,255,0.25);color:var(--blue-light);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;transition:all 0.18s;}
.brecibir:hover{background:rgba(77,122,255,0.2);}
.bchat{padding:5px 11px;background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.2);color:var(--yellow);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;transition:all 0.18s;}
.bchat:hover{background:rgba(255,204,0,0.15);}
.bvendido{padding:5px 11px;background:rgba(0,214,143,0.1);border:1px solid rgba(0,214,143,0.22);color:var(--green);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;transition:all 0.18s;}
.bvendido:hover{background:rgba(0,214,143,0.18);}
.brej{padding:5px 10px;background:rgba(255,77,109,0.07);border:1px solid rgba(255,77,109,0.18);color:var(--red);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;}
.empty-state{padding:32px 22px;text-align:center;color:var(--muted);font-size:13px;}
.pt{width:100%;}
.pr{display:grid;grid-template-columns:44px 1fr 76px 76px 72px 52px;align-items:center;gap:10px;padding:11px 22px;border-bottom:1px solid var(--border);}
.pr:last-child{border-bottom:none;}
.pr:not(.ph):hover{background:rgba(255,255,255,0.02);}
.ph{font-size:10px;font-weight:600;letter-spacing:0.7px;text-transform:uppercase;color:var(--muted);}
.pimg{width:38px;height:38px;border-radius:9px;background:var(--dark-3);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.pimg img{width:100%;height:100%;object-fit:cover;}
.pname{font-size:13px;font-weight:500;margin-bottom:2px;}.psub{font-size:10px;color:var(--muted);}
.pprice{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;}
.pcomm{font-size:13px;font-weight:500;color:var(--green);}
.pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:100px;font-size:10px;font-weight:500;}
.pon{background:rgba(0,214,143,0.08);color:var(--green);border:1px solid rgba(0,214,143,0.18);}
.poff{background:rgba(255,255,255,0.04);color:var(--muted);border:1px solid var(--border);}
.pacts{display:flex;gap:5px;}
.ibtn{width:26px;height:26px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.18s;}
.ibtn:hover{background:var(--card-bg);color:var(--text);}
.profile-card{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;margin-top:18px;}
.pf-body{padding:20px 22px;}
.pf-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.pf-group{display:flex;flex-direction:column;gap:6px;}
.pf-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:0.5px;}
.pf-input{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;width:100%;}
.pf-input:focus{border-color:rgba(0,214,143,0.4);}
.pf-input::placeholder{color:var(--muted);}
.btn-save-profile{padding:10px 20px;background:rgba(0,214,143,0.12);border:1px solid rgba(0,214,143,0.25);color:var(--green);font-family:'Syne',sans-serif;font-weight:700;font-size:13px;border-radius:10px;cursor:pointer;transition:all 0.2s;}
.btn-save-profile:hover{background:rgba(0,214,143,0.2);}
.pf-saved{font-size:12px;color:var(--green);margin-left:12px;display:none;}
/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--dark-2);border:1px solid var(--border);border-radius:24px;padding:32px;width:100%;max-width:520px;position:relative;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;letter-spacing:-0.3px;margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:22px;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px;display:block;}
.form-input{width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:rgba(26,86,255,0.4);}
.form-input::placeholder{color:var(--muted);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.commission-preview{background:var(--dark-3);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:var(--muted);}
.commission-preview strong{color:var(--green);font-size:15px;font-family:'Syne',sans-serif;font-weight:700;}
.modal-select{width:100%;background:var(--dark-3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;}
.btn-modal{width:100%;padding:13px;background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.btn-modal:hover:not(:disabled){background:var(--blue-light);}
.btn-modal:disabled{opacity:0.6;}
.modal-close{position:absolute;top:18px;right:18px;width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.18s;}
.modal-close:hover{background:var(--card-bg);color:var(--text);}
/* File upload */
.file-upload-area{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.file-upload-area:hover{border-color:rgba(26,86,255,0.4);background:rgba(26,86,255,0.04);}
.file-upload-area input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.file-upload-text{font-size:13px;color:var(--muted);}
.file-upload-text strong{color:var(--blue-light);}
.file-preview{margin-top:10px;position:relative;display:inline-block;}
.file-preview img{width:80px;height:80px;border-radius:10px;object-fit:cover;border:1px solid var(--border);}
.file-preview-remove{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px;color:#fff;border:none;}
.upload-progress{margin-top:8px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.upload-progress-bar{height:100%;background:var(--blue);width:0%;transition:width 0.3s;}
.error-msg{color:var(--red);font-size:12px;margin-top:8px;display:none;}
.loading-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
/* Variants UI */
.variants-toggle{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.toggle-label{font-size:13px;color:var(--muted);}
.toggle-switch{position:relative;width:38px;height:20px;cursor:pointer;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-track{position:absolute;inset:0;background:var(--dark-3);border:1px solid var(--border);border-radius:20px;transition:all 0.2s;}
.toggle-switch input:checked + .toggle-track{background:rgba(26,86,255,0.3);border-color:var(--blue);}
.toggle-knob{position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--muted);border-radius:50%;transition:all 0.2s;}
.toggle-switch input:checked ~ .toggle-knob{left:20px;background:var(--blue-light);}
.variants-section{display:none;margin-bottom:14px;}
.variants-section.show{display:block;}
.variant-row{display:grid;grid-template-columns:1.5fr 100px 100px 60px 60px 28px;gap:8px;align-items:center;margin-bottom:8px;}
.variant-input{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;width:100%;}
.variant-input:focus{border-color:rgba(26,86,255,0.4);}
.btn-add-variant{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;background:rgba(26,86,255,0.08);border:1px solid rgba(26,86,255,0.2);color:var(--blue-light);border-radius:8px;font-size:12px;cursor:pointer;transition:all 0.18s;margin-top:4px;}
.btn-add-variant:hover{background:rgba(26,86,255,0.15);}
.btn-del-variant{width:24px;height:24px;border-radius:6px;border:1px solid rgba(255,77,109,0.2);background:rgba(255,77,109,0.06);color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
/* CHAT */
.chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);z-index:300;display:none;align-items:center;justify-content:center;}
.chat-overlay.open{display:flex;}
.chat-box{background:var(--dark-2);border:1px solid var(--border);border-radius:24px;width:440px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;}
.chat-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0;}
.chat-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;}
.chat-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.chat-close{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;min-height:200px;max-height:380px;}
.chat-messages::-webkit-scrollbar{width:4px;}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.msg{display:flex;flex-direction:column;max-width:78%;}
.msg.mine{align-self:flex-end;align-items:flex-end;}
.msg.theirs{align-self:flex-start;align-items:flex-start;}
.msg-sender{font-size:10px;color:var(--muted);margin-bottom:3px;font-weight:500;}
.msg-bubble{padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.45;}
.msg.mine .msg-bubble{background:rgba(26,86,255,0.25);border:1px solid rgba(26,86,255,0.3);border-bottom-right-radius:4px;}
.msg.theirs .msg-bubble{background:rgba(255,255,255,0.06);border:1px solid var(--border);border-bottom-left-radius:4px;}
.msg-time{font-size:10px;color:var(--muted);margin-top:3px;}
.chat-vendido-banner{margin:0 16px 12px;padding:10px 14px;background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.2);border-radius:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-shrink:0;}
.chat-vendido-banner span{font-size:12px;color:var(--green);}
.btn-vendido-mini{padding:7px 14px;background:rgba(0,214,143,0.15);border:1px solid rgba(0,214,143,0.3);color:var(--green);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.18s;font-family:'Syne',sans-serif;}
.btn-vendido-mini:hover{background:rgba(0,214,143,0.25);}
.btn-vendido-mini:disabled{opacity:0.5;}
.chat-input-row{display:flex;gap:8px;padding:14px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.chat-input{flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;resize:none;}
.chat-input:focus{border-color:rgba(26,86,255,0.4);}
.chat-send-btn{width:38px;height:38px;border-radius:10px;background:var(--blue);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.18s;}
.chat-send-btn:hover{background:var(--blue-light);}
.chat-empty{text-align:center;color:var(--muted);font-size:12px;padding:24px;}
.step-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:10px;font-weight:600;}
.step-1{background:rgba(255,204,0,0.1);color:var(--yellow);border:1px solid rgba(255,204,0,0.2);}
.step-2{background:rgba(77,122,255,0.1);color:var(--blue-light);border:1px solid rgba(77,122,255,0.2);}
.step-3{background:rgba(0,214,143,0.1);color:var(--green);border:1px solid rgba(0,214,143,0.2);}
.step-x{background:rgba(255,77,109,0.07);color:var(--red);border:1px solid rgba(255,77,109,0.15);}
/* Vendor offering banner */
.offering-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:100px;font-size:10px;font-weight:600;background:rgba(0,214,143,0.08);color:var(--green);border:1px solid rgba(0,214,143,0.18);}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-head">
    <div class="sb-logo">VentaConecta</div>
    <div class="sb-user">
      <div class="sb-avatar" id="userInitials">?</div>
      <div><div class="sb-name" id="userName">Cargando...</div><div class="sb-role">Comercio</div></div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Principal</div>
    <a class="sb-item active">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>
    <a class="sb-item">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      Notificaciones
      <span class="sb-badge" id="notifBadge" style="display:none;">0</span>
    </a>
  </nav>
  <div class="sb-foot">
    <button class="logout-btn" onclick="handleLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Cerrar sesi√≥n
    </button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="greeting">Bienvenido üëã</div>
      <div class="page-sub" id="dateStr">Cargando...</div>
    </div>
    <button class="btn-new" onclick="openModal()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Agregar producto
    </button>
  </div>

  <div class="stats">
    <div class="sc"><div class="sc-icon sci-b"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="2" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div><div class="sc-val vb" id="stat-productos">‚Äî</div><div class="sc-lbl">Productos activos</div></div>
    <div class="sc"><div class="sc-icon sci-g"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div class="sc-val vg" id="stat-vendedores">‚Äî</div><div class="sc-lbl">Vendedores activos</div></div>
    <div class="sc"><div class="sc-icon sci-y"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></div><div class="sc-val vy" id="stat-ventas">‚Äî</div><div class="sc-lbl">Ventas generadas</div></div>
    <div class="sc"><div class="sc-icon sci-r"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff8fa3" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="sc-val vr" id="stat-comisiones">‚Äî</div><div class="sc-lbl">Comisiones pagadas</div></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="card-head"><div class="card-title">Clientes entrantes</div></div>
      <div id="notifList"><div class="empty-state">Cargando...</div></div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">Mis productos</div></div>
      <div class="pt">
        <div class="pr ph"><div></div><div>Producto</div><div>Precio</div><div>Comisi√≥n</div><div>Stock</div><div></div></div>
        <div id="productList"><div class="empty-state">Cargando...</div></div>
      </div>
    </div>
  </div>

  <div class="profile-card">
    <div class="card-head">
      <div class="card-title">üìç Info de tu negocio <span style="font-size:11px;font-weight:400;color:var(--muted);">‚Äî Los vendedores ver√°n esto para saber d√≥nde cobrar</span></div>
    </div>
    <div class="pf-body">
      <div class="pf-row">
        <div class="pf-group"><label class="pf-label">Direcci√≥n del negocio</label><input class="pf-input" type="text" id="pf-address" placeholder="Ej. Av. Revoluci√≥n 123, Tijuana"></div>
        <div class="pf-group"><label class="pf-label">WhatsApp (10 d√≠gitos)</label><input class="pf-input" type="tel" id="pf-whatsapp" placeholder="664 123 4567"></div>
      </div>
      <button class="btn-save-profile" onclick="saveProfile()">Guardar informaci√≥n</button>
      <span class="pf-saved" id="pfSaved">‚úì Guardado</span>
    </div>
  </div>
</main>

<!-- MODAL AGREGAR PRODUCTO -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div class="modal-title">Agregar producto</div>
    <div class="modal-sub">Publica un producto para que los vendedores lo promuevan</div>

    <div class="form-group">
      <label class="form-label">Foto del producto (opcional)</label>
      <div class="file-upload-area" id="uploadArea">
        <input type="file" id="p-photo" accept="image/*" onchange="handleFileSelect(this)">
        <div id="uploadPlaceholder">
          <div style="color:var(--muted);margin-bottom:8px;"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
          <div class="file-upload-text">Arrastra o <strong>haz clic para seleccionar</strong></div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">JPG, PNG, WebP ¬∑ M√°x 5MB</div>
        </div>
        <div id="filePreviewContainer" style="display:none;">
          <div class="file-preview"><img id="filePreviewImg" src="" alt="preview"><button class="file-preview-remove" onclick="removeFile(event)">‚úï</button></div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px;" id="fileName"></div>
        </div>
      </div>
      <div class="upload-progress" id="uploadProgress" style="display:none;"><div class="upload-progress-bar" id="uploadProgressBar"></div></div>
      <div class="error-msg" id="photoError"></div>
    </div>

    <div class="form-group"><label class="form-label">T√≠tulo del producto</label><input class="form-input" type="text" id="p-title" placeholder="Ej. Pantal√≥n de Vestir Azul"></div>
    <div class="form-group"><label class="form-label">Descripci√≥n</label><textarea class="form-input" id="p-desc" placeholder="Describe el producto: material, caracter√≠sticas, etc." rows="3" style="resize:vertical;"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Precio al p√∫blico ($)</label><input class="form-input" type="number" id="p-retail" placeholder="1200" oninput="updateCommission()"></div>
      <div class="form-group"><label class="form-label">Tu precio / costo ($)</label><input class="form-input" type="number" id="p-wholesale" placeholder="900" oninput="updateCommission()"></div>
    </div>
    <div class="commission-preview" id="commPreview">Comisi√≥n para el vendedor: <strong>$‚Äî</strong></div>
    <div class="form-group"><label class="form-label">Tipo de pago de comisi√≥n</label><select class="modal-select" id="p-payment"><option value="efectivo">Efectivo</option><option value="transferencia">Transferencia</option><option value="ambos">Efectivo o transferencia</option></select></div>

    <!-- INVENTARIO -->
    <div style="border-top:1px solid var(--border);margin:18px 0 14px;padding-top:18px;">
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;margin-bottom:12px;">üì¶ Inventario</div>
      <div class="variants-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="hasVariants" onchange="toggleVariants()">
          <div class="toggle-track"></div>
          <div class="toggle-knob"></div>
        </label>
        <span class="toggle-label">Este producto tiene variantes (tallas, colores, etc.)</span>
      </div>

      <!-- Sin variantes: solo cantidad -->
      <div id="stockSimple">
        <div class="form-group"><label class="form-label">Cantidad en inventario</label><input class="form-input" type="number" id="p-stock" placeholder="Ej. 10" min="0"></div>
      </div>

      <!-- Con variantes -->
      <div class="variants-section" id="variantsSection">
        <div id="variantRows"></div>
        <div style="display:grid;grid-template-columns:1fr 80px 80px 80px 28px;gap:8px;margin-bottom:6px;padding:0 2px;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:0.5px;">VARIANTE</div>
          <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:0.5px;text-align:center;">CANT.</div>
          <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:0.5px;text-align:center;">P. P√öBLICO</div>
          <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:0.5px;text-align:center;">TU COSTO</div>
          <div></div>
        </div>
        <button class="btn-add-variant" onclick="addVariantRow()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Agregar variante
        </button>
      </div>
    </div>

    <div class="error-msg" id="saveError" style="display:block;"></div>
    <button class="btn-modal" id="saveProductBtn" onclick="saveProduct()">Publicar producto</button>
  </div>
</div>

<!-- CHAT MODAL -->
<div class="chat-overlay" id="chatOverlay">
  <div class="chat-box">
    <div class="chat-head">
      <div><div class="chat-title" id="chatTitle">Chat</div><div class="chat-sub" id="chatSub">Coordinando visita</div></div>
      <button class="chat-close" onclick="closeChat()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="chat-messages" id="chatMessages"><div class="chat-empty">Cargando...</div></div>
    <div class="chat-vendido-banner" id="chatVendidoBanner" style="display:none;">
      <span>¬øEl cliente compr√≥? Cierra la venta y activa la comisi√≥n.</span>
      <button class="btn-vendido-mini" id="btnMarcarVendido" onclick="marcarVendido()">‚úÖ Marcar vendido</button>
    </div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." rows="1" onkeydown="handleChatKey(event)"></textarea>
      <button class="chat-send-btn" onclick="sendMessage()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL='https://miiitegvpxoplanszido.supabase.co'
const SUPABASE_KEY='sb_publishable_uONmieVhZiope7XWhMnFHA_gQbIHF2w'
const {createClient}=supabase
const sb=createClient(SUPABASE_URL,SUPABASE_KEY)
let currentUser=null,currentProfile=null,selectedFile=null
let chatNotifId=null,chatVendorId=null,chatCommission=0,chatChannel=null

async function init(){
  const {data:{user}}=await sb.auth.getUser()
  if(!user){window.location.href='login.html';return}
  currentUser=user
  const {data:profile}=await sb.from('users').select('*').eq('id',user.id).single()
  if(!profile||profile.user_type!=='comercio'){window.location.href='login.html';return}
  currentProfile=profile
  const name=profile.business_name||profile.email
  document.getElementById('userName').textContent=name
  document.getElementById('userInitials').textContent=name.substring(0,2).toUpperCase()
  document.getElementById('greeting').textContent=`Bienvenido, ${name.split(' ')[0]} üëã`
  if(profile.address)document.getElementById('pf-address').value=profile.address
  if(profile.whatsapp)document.getElementById('pf-whatsapp').value=profile.whatsapp
  const now=new Date()
  document.getElementById('dateStr').textContent=now.toLocaleDateString('es-MX',{weekday:'long',year:'numeric',month:'long',day:'numeric'})
  loadStats();loadNotifications();loadProducts()
  subscribeToNewNotifications()
}

async function loadStats(){
  const uid=currentUser.id
  const [prods,ventas,notifs,sales]=await Promise.all([
    sb.from('products').select('id',{count:'exact',head:true}).eq('comercio_id',uid).eq('active',true),
    sb.from('sales').select('id',{count:'exact',head:true}).eq('comercio_id',uid),
    sb.from('notifications').select('vendedor_id').eq('comercio_id',uid),
    sb.from('sales').select('commission_amount').eq('comercio_id',uid).eq('commission_paid',true)
  ])
  document.getElementById('stat-productos').textContent=prods.count||0
  document.getElementById('stat-ventas').textContent=ventas.count||0
  const uniqueVendedores=new Set((notifs.data||[]).map(n=>n.vendedor_id)).size
  document.getElementById('stat-vendedores').textContent=uniqueVendedores
  const total=(sales.data||[]).reduce((s,r)=>s+(r.commission_amount||0),0)
  document.getElementById('stat-comisiones').textContent='$'+total.toLocaleString()
}

async function loadNotifications(){
  const {data}=await sb.from('notifications')
    .select('*, products(title,commission), users!vendedor_id(full_name,email)')
    .eq('comercio_id',currentUser.id).order('created_at',{ascending:false}).limit(8)
  const list=document.getElementById('notifList')
  const active=(data||[]).filter(n=>n.status==='enviado')
  const badge=document.getElementById('notifBadge')
  if(active.length>0){badge.textContent=active.length;badge.style.display='inline'}else{badge.style.display='none'}
  if(!data||data.length===0){list.innerHTML='<div class="empty-state">No hay notificaciones a√∫n</div>';return}
  list.innerHTML=data.map(n=>{
    const vendName=n.users?.full_name||n.users?.email||'vendedor'
    const prodTitle=n.products?.title||'producto'
    const commission=n.products?.commission||0
    let dotClass,badge,actions
    if(n.status==='enviado'){
      dotClass='dy';badge='<span class="step-badge step-1">Paso 1 ¬∑ Nuevo</span>'
      actions=`<div class="ni-acts"><button class="brecibir" onclick="acusarRecibo('${n.id}')">üì¨ Recibido ¬∑ Chatear</button><button class="brej" onclick="rejectNotif('${n.id}')">‚úó</button></div>`
    }else if(n.status==='recibido'){
      dotClass='db';badge='<span class="step-badge step-2">Paso 2 ¬∑ En chat</span>'
      const sp=encodeURIComponent(prodTitle),sv=encodeURIComponent(vendName)
      actions=`<div class="ni-acts"><button class="bchat" onclick="openChat('${n.id}','${n.vendedor_id}',${commission},'${sp}','${sv}')">üí¨ Chat</button><button class="bvendido" onclick="marcarVendidoDirecto('${n.id}','${n.vendedor_id}',${commission})">‚úÖ Vendido</button></div>`
    }else if(n.status==='vendido'){
      dotClass='dg';badge='<span class="step-badge step-3">‚úì Vendido</span>';actions=''
    }else if(n.status==='rechazado'){
      dotClass='dr';badge='<span class="step-badge step-x">‚úó Rechazado</span>';actions=''
    }else{
      dotClass='dg';badge='<span class="step-badge step-3">‚úì Confirmado</span>';actions=''
    }
    return `<div class="ni"><div class="ndot ${dotClass}"></div><div class="ni-body"><div class="ni-txt"><strong>${n.customer_name}</strong> ‚Üí <strong>${prodTitle}</strong></div><div class="ni-meta">${badge} ¬∑ @${vendName} ¬∑ ${n.expected_visit||''}</div></div>${actions}</div>`
  }).join('')
}

async function acusarRecibo(id){await sb.from('notifications').update({status:'recibido'}).eq('id',id);loadNotifications()}
async function rejectNotif(id){await sb.from('notifications').update({status:'rechazado'}).eq('id',id);loadNotifications()}

async function marcarVendidoDirecto(notifId,vendorId,commission){
  if(!confirm('¬øConfirmar venta? Se activar√° la comisi√≥n del vendedor.'))return
  await _registrarVenta(notifId,vendorId,commission)
}

async function _registrarVenta(notifId,vendorId,commission){
  const {data:notif}=await sb.from('notifications').select('product_id').eq('id',notifId).single()
  await sb.from('notifications').update({status:'vendido'}).eq('id',notifId)
  await sb.from('sales').insert({notification_id:notifId,product_id:notif?.product_id,vendedor_id:vendorId,comercio_id:currentUser.id,sale_amount:commission,commission_amount:commission,commission_paid:false})
  // Descontar stock
  if(notif?.product_id){
    const {data:prod}=await sb.from('products').select('stock,has_variants').eq('id',notif.product_id).single()
    if(prod&&!prod.has_variants&&prod.stock>0){
      await sb.from('products').update({stock:prod.stock-1}).eq('id',notif.product_id)
    }
  }
  loadNotifications();loadStats();loadProducts()
}

async function loadProducts(){
  const list=document.getElementById('productList')
  const {data,error}=await sb.from('products').select('*').eq('comercio_id',currentUser.id).order('created_at',{ascending:false}).limit(10)
  if(error){list.innerHTML=`<div class="empty-state">Error: ${error.message}</div>`;return}
  if(!data||data.length===0){list.innerHTML='<div class="empty-state">No tienes productos a√∫n</div>';return}

  // Load vendor count per product
  const productIds=data.map(p=>p.id)
  const {data:vpData}=await sb.from('vendor_products').select('product_id').in('product_id',productIds)
  const vpCount={}
  ;(vpData||[]).forEach(vp=>{vpCount[vp.product_id]=(vpCount[vp.product_id]||0)+1})

  list.innerHTML=data.map(p=>{
    const imgHtml=p.image_url?`<img src="${p.image_url}" alt="${p.title}">`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="1.5" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8"/></svg>`
    const count=vpCount[p.id]||0
    const offeringBadge=count>0?`<span class="offering-badge">üë• ${count}</span>`:''
    const stockDisplay=p.has_variants?'vars':''+( p.stock||0)
    return `<div class="pr"><div class="pimg">${imgHtml}</div><div><div class="pname">${p.title}</div><div class="psub">${offeringBadge} ${count>0?count+' vendedor'+(count>1?'es':''):''}</div></div><div class="pprice">$${(p.retail_price||0).toLocaleString()}</div><div class="pcomm">+$${(p.commission||0).toLocaleString()}</div><div style="font-size:12px;color:${p.stock===0&&!p.has_variants?'var(--red)':'var(--muted)'};">${p.has_variants?'Variantes':(p.stock||0)+' pzs'}</div><div class="pacts"><button class="ibtn" onclick="deleteProduct('${p.id}')" title="Eliminar"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></button></div></div>`
  }).join('')
}

async function deleteProduct(id){if(!confirm('¬øEliminar este producto?'))return;const {error}=await sb.from('products').delete().eq('id',id);if(error){alert('Error: '+error.message);return;}loadProducts();loadStats()}

// VARIANTS UI
function toggleVariants(){
  const hasV=document.getElementById('hasVariants').checked
  document.getElementById('stockSimple').style.display=hasV?'none':'block'
  document.getElementById('variantsSection').classList.toggle('show',hasV)
  if(hasV&&document.getElementById('variantRows').children.length===0)addVariantRow()
}

function calcVariantComm(input){
  const row=input.closest('.variant-row')
  const inputs=row.querySelectorAll('input[type="number"]')
  const retail=parseFloat(inputs[0].value)||0
  const wholesale=parseFloat(inputs[1].value)||0
  const comm=retail-wholesale
  row.querySelector('.variant-comm').textContent=comm>0?'+$'+comm.toLocaleString():'$‚Äî'
}
function addVariantRow(){
  const container=document.getElementById('variantRows')
  const row=document.createElement('div')
  row.className='variant-row-full'
  row.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 80px 80px 80px 28px;gap:8px;align-items:center;margin-bottom:8px;">
      <input class="variant-input vname" type="text" placeholder="Ej. King Size, Talla M...">
      <input class="variant-input vqty" type="number" placeholder="Qty" min="0" style="text-align:center;" title="Cantidad">
      <input class="variant-input vretail" type="number" placeholder="P. p√∫blico" min="0" oninput="updateVariantComm(this)" title="Precio p√∫blico">
      <input class="variant-input vwholesale" type="number" placeholder="Tu costo" min="0" oninput="updateVariantComm(this)" title="Tu costo">
      <button class="btn-del-variant" onclick="this.closest('.variant-row-full').remove()">√ó</button>
    </div>
    <div class="variant-comm-preview" style="font-size:11px;color:var(--muted);margin-bottom:10px;padding-left:4px;">Comisi√≥n: <strong style="color:var(--green);">$‚Äî</strong></div>`
  container.appendChild(row)
}

function updateVariantComm(input){
  const row=input.closest('.variant-row-full')
  const retail=parseFloat(row.querySelector('.vretail').value)||0
  const wholesale=parseFloat(row.querySelector('.vwholesale').value)||0
  const comm=retail-wholesale
  row.querySelector('.variant-comm-preview').innerHTML=`Comisi√≥n: <strong style="color:var(--green);">${comm>0?'$'+comm.toLocaleString():'$‚Äî'}</strong>`
}

function updateCommission(){
  const retail=parseFloat(document.getElementById('p-retail').value)||0
  const wholesale=parseFloat(document.getElementById('p-wholesale').value)||0
  const comm=retail-wholesale
  document.getElementById('commPreview').innerHTML=`Comisi√≥n para el vendedor: <strong>${comm>0?'$'+comm.toLocaleString():'‚Äî'}</strong>`
}

function handleFileSelect(input){
  const file=input.files[0];if(!file)return
  if(file.size>5*1024*1024){showPhotoError('M√°ximo 5MB');input.value='';return}
  if(!file.type.startsWith('image/')){showPhotoError('Selecciona una imagen');input.value='';return}
  selectedFile=file;hidePhotoError()
  const reader=new FileReader()
  reader.onload=e=>{document.getElementById('filePreviewImg').src=e.target.result;document.getElementById('fileName').textContent=file.name;document.getElementById('uploadPlaceholder').style.display='none';document.getElementById('filePreviewContainer').style.display='block'}
  reader.readAsDataURL(file)
}
function removeFile(e){if(e){e.stopPropagation();e.preventDefault()}selectedFile=null;document.getElementById('p-photo').value='';document.getElementById('uploadPlaceholder').style.display='block';document.getElementById('filePreviewContainer').style.display='none'}
function showPhotoError(msg){const el=document.getElementById('photoError');el.textContent=msg;el.style.display='block'}
function hidePhotoError(){document.getElementById('photoError').style.display='none'}

async function uploadPhoto(file){
  const ext=file.name.split('.').pop()
  const fileName=`${currentUser.id}/${Date.now()}.${ext}`
  const prog=document.getElementById('uploadProgress'),bar=document.getElementById('uploadProgressBar')
  prog.style.display='block';bar.style.width='30%'
  const {error}=await sb.storage.from('product-images').upload(fileName,file,{cacheControl:'3600',upsert:false})
  bar.style.width='100%'
  if(error){prog.style.display='none';throw new Error(error.message)}
  const {data:{publicUrl}}=sb.storage.from('product-images').getPublicUrl(fileName)
  return publicUrl
}

async function saveProduct(){
  const title=document.getElementById('p-title').value.trim()
  const desc=document.getElementById('p-desc').value.trim()
  const retail=parseFloat(document.getElementById('p-retail').value)
  const wholesale=parseFloat(document.getElementById('p-wholesale').value)
  const payment=document.getElementById('p-payment').value
  const hasV=document.getElementById('hasVariants').checked
  const errEl=document.getElementById('saveError');errEl.textContent=''
  if(!title||!retail||!wholesale){errEl.textContent='Llena todos los campos obligatorios.';return}
  if(retail<=wholesale){errEl.textContent='El precio p√∫blico debe ser mayor al costo.';return}
  const btn=document.getElementById('saveProductBtn');btn.disabled=true;btn.innerHTML='<span class="loading-spinner"></span>Publicando...'
  try{
    let imageUrl=null
    if(selectedFile){btn.innerHTML='<span class="loading-spinner"></span>Subiendo foto...';imageUrl=await uploadPhoto(selectedFile)}
    btn.innerHTML='<span class="loading-spinner"></span>Guardando...'
    const stock=hasV?0:parseInt(document.getElementById('p-stock').value)||0
    const {data:prod,error}=await sb.from('products').insert({
      comercio_id:currentUser.id,title,description:desc,retail_price:retail,wholesale_price:wholesale,
      commission:retail-wholesale,commission_payment_type:payment,image_url:imageUrl,
      active:true,views:0,sales_count:0,has_variants:hasV,stock
    }).select().single()
    if(error){errEl.textContent=`Error: ${error.message}`;btn.disabled=false;btn.textContent='Publicar producto';return}
    // Save variants
    if(hasV&&prod){
      const rows=document.querySelectorAll('#variantRows .variant-row-full')
      const variants=[]
      rows.forEach(row=>{
        const name=row.querySelector('.vname').value.trim()
        const qty=parseInt(row.querySelector('.vqty').value)||0
        const retail=parseFloat(row.querySelector('.vretail').value)||0
        const wholesale=parseFloat(row.querySelector('.vwholesale').value)||0
        const commission=retail-wholesale
        if(name)variants.push({product_id:prod.id,name,stock:qty,retail_price:retail,wholesale_price:wholesale,commission})
      })
      if(variants.length>0)await sb.from('product_variants').insert(variants)
    }
    closeModal();await loadProducts();await loadStats()
  }catch(err){errEl.textContent=err.message||'Error inesperado.';btn.disabled=false;btn.textContent='Publicar producto'}
}

async function saveProfile(){
  const address=document.getElementById('pf-address').value.trim()
  const whatsapp=document.getElementById('pf-whatsapp').value.trim()
  await sb.from('users').update({address,whatsapp}).eq('id',currentUser.id)
  const saved=document.getElementById('pfSaved');saved.style.display='inline';setTimeout(()=>{saved.style.display='none'},2500)
}

// CHAT
function openChat(notifId,vendorId,commission,sp,sv){
  chatNotifId=notifId;chatVendorId=vendorId;chatCommission=commission
  document.getElementById('chatTitle').textContent=`Chat ¬∑ ${decodeURIComponent(sp)}`
  document.getElementById('chatSub').textContent=`Con ${decodeURIComponent(sv)}`
  document.getElementById('chatVendidoBanner').style.display='flex'
  const btn=document.getElementById('btnMarcarVendido');btn.disabled=false;btn.textContent='‚úÖ Marcar vendido'
  document.getElementById('chatOverlay').classList.add('open')
  document.getElementById('chatInput').value=''
  loadMessages();subscribeToChat()
}
async function loadMessages(){
  const container=document.getElementById('chatMessages')
  const {data,error}=await sb.from('messages').select('*, users!sender_id(full_name,business_name,email)').eq('notification_id',chatNotifId).order('created_at',{ascending:true})
  if(error||!data||data.length===0){container.innerHTML='<div class="chat-empty">üí¨ Sin mensajes a√∫n</div>';return}
  container.innerHTML=data.map(msg=>{
    const isMine=msg.sender_id===currentUser.id
    const name=msg.users?.business_name||msg.users?.full_name||msg.users?.email||'?'
    const time=new Date(msg.created_at).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})
    return `<div class="msg ${isMine?'mine':'theirs'}"><div class="msg-sender">${isMine?'T√∫':name}</div><div class="msg-bubble">${msg.text}</div><div class="msg-time">${time}</div></div>`
  }).join('')
  container.scrollTop=container.scrollHeight
}
function subscribeToChat(){
  if(chatChannel){sb.removeChannel(chatChannel);chatChannel=null}
  chatChannel=sb.channel('chat-c-'+chatNotifId).on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`notification_id=eq.${chatNotifId}`},()=>loadMessages()).subscribe()
}
async function sendMessage(){
  const text=document.getElementById('chatInput').value.trim()
  if(!text||!chatNotifId)return
  document.getElementById('chatInput').value=''
  await sb.from('messages').insert({notification_id:chatNotifId,sender_id:currentUser.id,text})
  loadMessages()
}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}}
async function marcarVendido(){
  const btn=document.getElementById('btnMarcarVendido');btn.disabled=true;btn.textContent='Registrando...'
  await _registrarVenta(chatNotifId,chatVendorId,chatCommission)
  closeChat()
}
function closeChat(){
  document.getElementById('chatOverlay').classList.remove('open')
  if(chatChannel){sb.removeChannel(chatChannel);chatChannel=null}
  chatNotifId=null
}
function subscribeToNewNotifications(){
  sb.channel('notifs-c-'+currentUser.id).on('postgres_changes',{event:'*',schema:'public',table:'notifications',filter:`comercio_id=eq.${currentUser.id}`},()=>{loadNotifications();loadStats()}).subscribe()
}
function openModal(){
  ['p-title','p-retail','p-wholesale','p-stock'].forEach(id=>document.getElementById(id).value='')
  document.getElementById('p-desc').value=''
  document.getElementById('saveError').textContent=''
  document.getElementById('uploadProgress').style.display='none'
  document.getElementById('uploadProgressBar').style.width='0%'
  document.getElementById('hasVariants').checked=false
  document.getElementById('stockSimple').style.display='block'
  document.getElementById('variantsSection').classList.remove('show')
  document.getElementById('variantRows').innerHTML=''
  removeFile(null);selectedFile=null
  document.getElementById('saveProductBtn').disabled=false;document.getElementById('saveProductBtn').textContent='Publicar producto'
  document.getElementById('commPreview').innerHTML='Comisi√≥n para el vendedor: <strong>$‚Äî</strong>'
  document.getElementById('productModal').classList.add('open')
}
function closeModal(){document.getElementById('productModal').classList.remove('open')}
async function handleLogout(){await sb.auth.signOut();window.location.href='login.html'}
init()
</script>
</body>
</html>
