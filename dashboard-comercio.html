<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VentaConecta ‚Äî Dashboard Comercio</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--blue:#1a56ff;--blue-light:#4d7aff;--green:#00d68f;--yellow:#ffcc00;--red:#ff4d6d;--dark:#070b14;--dark-2:#0f1623;--dark-3:#1a2235;--card-bg:rgba(255,255,255,0.035);--border:rgba(255,255,255,0.07);--text:#eef2ff;--muted:rgba(238,242,255,0.45);}
body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);display:flex;min-height:100vh;}
.sidebar{width:248px;min-height:100vh;background:var(--dark-2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-head{padding:24px 24px 20px;border-bottom:1px solid var(--border);}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;background:linear-gradient(120deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:16px;}
.sb-user{display:flex;align-items:center;gap:10px;}
.sb-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue-light));display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;color:#fff;flex-shrink:0;}
.sb-name{font-size:13px;font-weight:500;}
.sb-role{font-size:11px;color:var(--muted);}
.sb-nav{padding:16px 0;flex:1;}
.sb-section{padding:12px 20px 6px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:var(--muted);cursor:pointer;transition:all 0.18s;text-decoration:none;}
.sb-item:hover{color:var(--text);background:rgba(255,255,255,0.03);}
.sb-item.active{color:var(--text);background:rgba(26,86,255,0.1);border-right:2px solid var(--blue);}
.sb-badge{margin-left:auto;background:var(--yellow);color:#000;border-radius:100px;font-size:10px;font-weight:700;padding:2px 7px;}
.sb-foot{padding:16px 20px;border-top:1px solid var(--border);}
.logout-btn{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:color 0.2s;}
.logout-btn:hover{color:var(--red);}
.main{margin-left:248px;flex:1;padding:32px 36px;}
.topbar{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;letter-spacing:-0.7px;margin-bottom:3px;}
.page-sub{font-size:13px;color:var(--muted);}
.btn-new{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:13.5px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;}
.btn-new:hover{background:var(--blue-light);transform:translateY(-1px);box-shadow:0 8px 28px rgba(26,86,255,0.4);}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.sc{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:22px;position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent);}
.sc-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.sci-b{background:rgba(26,86,255,0.1);border:1px solid rgba(26,86,255,0.18);}
.sci-g{background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.16);}
.sci-y{background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.16);}
.sci-r{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.16);}
.sc-val{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-1px;margin-bottom:3px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.vb{background:linear-gradient(135deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vg{background:linear-gradient(135deg,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vy{background:linear-gradient(135deg,#fff,var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vr{background:linear-gradient(135deg,#fff,#ff8fa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;}
.card-link{font-size:12px;color:var(--blue-light);cursor:pointer;text-decoration:none;}
.ni{display:flex;align-items:flex-start;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);transition:background 0.18s;}
.ni:last-child{border-bottom:none;}
.ni:hover{background:rgba(255,255,255,0.02);}
.ndot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.dy{background:var(--yellow);box-shadow:0 0 8px rgba(255,204,0,0.5);}
.dg{background:var(--green);}
.dr{background:var(--red);}
.ni-body{flex:1;}
.ni-txt{font-size:13px;line-height:1.5;margin-bottom:3px;}
.ni-txt strong{font-weight:500;}
.ni-meta{font-size:11px;color:var(--muted);}
.ni-acts{display:flex;gap:5px;flex-shrink:0;margin-top:1px;}
.bconf{padding:5px 11px;background:rgba(0,214,143,0.1);border:1px solid rgba(0,214,143,0.22);color:var(--green);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;transition:all 0.18s;}
.bconf:hover{background:rgba(0,214,143,0.18);}
.brej{padding:5px 10px;background:rgba(255,77,109,0.07);border:1px solid rgba(255,77,109,0.18);color:var(--red);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;}
.empty-state{padding:32px 22px;text-align:center;color:var(--muted);font-size:13px;}
.pt{width:100%;}
.pr{display:grid;grid-template-columns:44px 1fr 76px 76px 72px 52px;align-items:center;gap:10px;padding:11px 22px;border-bottom:1px solid var(--border);}
.pr:last-child{border-bottom:none;}
.pr:not(.ph):hover{background:rgba(255,255,255,0.02);}
.ph{font-size:10px;font-weight:600;letter-spacing:0.7px;text-transform:uppercase;color:var(--muted);}
.pimg{width:38px;height:38px;border-radius:9px;background:var(--dark-3);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.pimg img{width:100%;height:100%;object-fit:cover;}
.pname{font-size:13px;font-weight:500;margin-bottom:2px;}
.psub{font-size:10px;color:var(--muted);}
.pprice{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;}
.pcomm{font-size:13px;font-weight:500;color:var(--green);}
.pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:100px;font-size:10px;font-weight:500;}
.pon{background:rgba(0,214,143,0.08);color:var(--green);border:1px solid rgba(0,214,143,0.18);}
.poff{background:rgba(255,255,255,0.04);color:var(--muted);border:1px solid var(--border);}
.pacts{display:flex;gap:5px;}
.ibtn{width:26px;height:26px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.18s;}
.ibtn:hover{background:var(--card-bg);color:var(--text);}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--dark-2);border:1px solid var(--border);border-radius:24px;padding:32px;width:100%;max-width:480px;position:relative;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;letter-spacing:-0.3px;margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:22px;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px;display:block;}
.form-input{width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:rgba(26,86,255,0.4);}
.form-input::placeholder{color:var(--muted);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.commission-preview{background:var(--dark-3);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:var(--muted);}
.commission-preview strong{color:var(--green);font-size:15px;font-family:'Syne',sans-serif;font-weight:700;}
.modal-select{width:100%;background:var(--dark-3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;}
.btn-modal{width:100%;padding:13px;background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.btn-modal:hover:not(:disabled){background:var(--blue-light);}
.btn-modal:disabled{opacity:0.6;}
.modal-close{position:absolute;top:18px;right:18px;width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.18s;}
.modal-close:hover{background:var(--card-bg);color:var(--text);}
/* FILE UPLOAD */
.file-upload-area{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.file-upload-area:hover{border-color:rgba(26,86,255,0.4);background:rgba(26,86,255,0.04);}
.file-upload-area.dragging{border-color:var(--blue);background:rgba(26,86,255,0.08);}
.file-upload-area input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.file-upload-icon{margin-bottom:8px;color:var(--muted);}
.file-upload-text{font-size:13px;color:var(--muted);}
.file-upload-text strong{color:var(--blue-light);}
.file-preview{margin-top:10px;position:relative;display:inline-block;}
.file-preview img{width:80px;height:80px;border-radius:10px;object-fit:cover;border:1px solid var(--border);}
.file-preview-remove{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px;color:#fff;border:none;}
.upload-progress{margin-top:8px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.upload-progress-bar{height:100%;background:var(--blue);width:0%;transition:width 0.3s;}
.error-msg{color:var(--red);font-size:12px;margin-top:8px;display:none;}
.loading-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-head">
    <div class="sb-logo">VentaConecta</div>
    <div class="sb-user">
      <div class="sb-avatar" id="userInitials">?</div>
      <div><div class="sb-name" id="userName">Cargando...</div><div class="sb-role">Comercio</div></div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Principal</div>
    <a class="sb-item active">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>
    <a class="sb-item" href="#">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      Mis productos
    </a>
    <a class="sb-item">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      Notificaciones
      <span class="sb-badge" id="notifBadge" style="display:none;">0</span>
    </a>
    <a class="sb-item">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Ventas
    </a>
  </nav>
  <div class="sb-foot">
    <button class="logout-btn" onclick="handleLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Cerrar sesi√≥n
    </button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="greeting">Buenos d√≠as üëã</div>
      <div class="page-sub" id="dateStr">Cargando...</div>
    </div>
    <button class="btn-new" onclick="openModal()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Agregar producto
    </button>
  </div>

  <div class="stats">
    <div class="sc"><div class="sc-icon sci-b"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="2" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div><div class="sc-val vb" id="stat-productos">‚Äî</div><div class="sc-lbl">Productos activos</div></div>
    <div class="sc"><div class="sc-icon sci-g"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></div><div class="sc-val vg" id="stat-ventas">‚Äî</div><div class="sc-lbl">Ventas generadas</div></div>
    <div class="sc"><div class="sc-icon sci-y"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="sc-val vy" id="stat-vendedores">‚Äî</div><div class="sc-lbl">Vendedores activos</div></div>
    <div class="sc"><div class="sc-icon sci-r"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff8fa3" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="sc-val vr" id="stat-comisiones">‚Äî</div><div class="sc-lbl">Comisiones pagadas</div></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="card-head"><div class="card-title">Clientes entrantes</div><a class="card-link">Ver todas ‚Üí</a></div>
      <div id="notifList"><div class="empty-state">Cargando notificaciones...</div></div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">Mis productos</div><a class="card-link">Ver todos ‚Üí</a></div>
      <div class="pt">
        <div class="pr ph"><div></div><div>Producto</div><div>Retail</div><div>Comisi√≥n</div><div>Estado</div><div></div></div>
        <div id="productList"><div class="empty-state">Cargando productos...</div></div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL AGREGAR PRODUCTO -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="modal-title">Agregar producto</div>
    <div class="modal-sub">Publica un producto para que los vendedores lo promuevan</div>

    <!-- FIX 3: Photo upload section -->
    <div class="form-group">
      <label class="form-label">Foto del producto (opcional)</label>
      <div class="file-upload-area" id="uploadArea">
        <input type="file" id="p-photo" accept="image/*" onchange="handleFileSelect(this)">
        <div id="uploadPlaceholder">
          <div class="file-upload-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </div>
          <div class="file-upload-text">Arrastra una imagen o <strong>haz clic para seleccionar</strong></div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">JPG, PNG, WebP ¬∑ M√°x 5MB</div>
        </div>
        <div id="filePreviewContainer" style="display:none;">
          <div class="file-preview">
            <img id="filePreviewImg" src="" alt="preview">
            <button class="file-preview-remove" onclick="removeFile(event)" title="Quitar foto">‚úï</button>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px;" id="fileName"></div>
        </div>
      </div>
      <div class="upload-progress" id="uploadProgress" style="display:none;">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
      </div>
      <div class="error-msg" id="photoError"></div>
    </div>

    <div class="form-group">
      <label class="form-label">T√≠tulo del producto</label>
      <input class="form-input" type="text" id="p-title" placeholder="Ej. Silla ejecutiva ergon√≥mica negra">
    </div>
    <div class="form-group">
      <label class="form-label">Descripci√≥n</label>
      <input class="form-input" type="text" id="p-desc" placeholder="Descripci√≥n del producto">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Precio al p√∫blico ($)</label>
        <input class="form-input" type="number" id="p-retail" placeholder="1200" oninput="updateCommission()">
      </div>
      <div class="form-group">
        <label class="form-label">Tu precio / costo ($)</label>
        <input class="form-input" type="number" id="p-wholesale" placeholder="900" oninput="updateCommission()">
      </div>
    </div>
    <div class="commission-preview" id="commPreview">Comisi√≥n para el vendedor: <strong>$‚Äî</strong></div>
    <div class="form-group">
      <label class="form-label">Tipo de pago de comisi√≥n</label>
      <select class="modal-select" id="p-payment">
        <option value="efectivo">Efectivo</option>
        <option value="transferencia">Transferencia</option>
        <option value="ambos">Efectivo o transferencia</option>
      </select>
    </div>
    <div class="error-msg" id="saveError" style="display:block;"></div>
    <button class="btn-modal" id="saveProductBtn" onclick="saveProduct()">Publicar producto</button>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://miiitegvpxoplanszido.supabase.co'
const SUPABASE_KEY = 'sb_publishable_uONmieVhZiope7XWhMnFHA_gQbIHF2w'
const { createClient } = supabase
const sb = createClient(SUPABASE_URL, SUPABASE_KEY)

let currentUser = null
let currentProfile = null
let selectedFile = null

async function init() {
  const { data: { user } } = await sb.auth.getUser()
  if (!user) { window.location.href = 'login.html'; return }
  currentUser = user

  const { data: profile } = await sb.from('users').select('*').eq('id', user.id).single()
  if (!profile || profile.user_type !== 'comercio') { window.location.href = 'login.html'; return }
  currentProfile = profile

  const name = profile.business_name || profile.email
  document.getElementById('userName').textContent = name
  document.getElementById('userInitials').textContent = name.substring(0, 2).toUpperCase()
  document.getElementById('greeting').textContent = `Bienvenido, ${name.split(' ')[0]} üëã`
  const now = new Date()
  document.getElementById('dateStr').textContent = now.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })

  loadStats()
  loadNotifications()
  loadProducts()
}

async function loadStats() {
  const uid = currentUser.id
  const [prods, ventas, notifs, sales] = await Promise.all([
    sb.from('products').select('id', { count: 'exact', head: true }).eq('comercio_id', uid).eq('active', true),
    sb.from('sales').select('id', { count: 'exact', head: true }).eq('comercio_id', uid),
    sb.from('notifications').select('vendedor_id').eq('comercio_id', uid),
    sb.from('sales').select('commission_amount').eq('comercio_id', uid).eq('commission_paid', true)
  ])
  document.getElementById('stat-productos').textContent = prods.count || 0
  document.getElementById('stat-ventas').textContent = ventas.count || 0
  const uniqueVendedores = new Set((notifs.data || []).map(n => n.vendedor_id)).size
  document.getElementById('stat-vendedores').textContent = uniqueVendedores
  const totalComisiones = (sales.data || []).reduce((s, r) => s + (r.commission_amount || 0), 0)
  document.getElementById('stat-comisiones').textContent = '$' + totalComisiones.toLocaleString()
}

async function loadNotifications() {
  const { data } = await sb
    .from('notifications')
    .select('*, products(title), users!vendedor_id(full_name, email)')
    .eq('comercio_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(5)

  const list = document.getElementById('notifList')
  const pending = (data || []).filter(n => n.status === 'enviado')
  if (pending.length > 0) {
    const badge = document.getElementById('notifBadge')
    badge.textContent = pending.length
    badge.style.display = 'inline'
  }
  if (!data || data.length === 0) { list.innerHTML = '<div class="empty-state">No hay notificaciones a√∫n</div>'; return }
  list.innerHTML = data.map(n => {
    const dotClass = n.status === 'enviado' ? 'dy' : n.status === 'confirmado' ? 'dg' : 'dr'
    const vendName = n.users?.full_name || n.users?.email || 'vendedor'
    const prodTitle = n.products?.title || 'producto'
    const actions = n.status === 'enviado'
      ? `<div class="ni-acts"><button class="bconf" onclick="confirmNotif('${n.id}')">‚úì Confirmar</button><button class="brej" onclick="rejectNotif('${n.id}')">‚úó</button></div>`
      : ''
    const statusText = n.status === 'confirmado' ? '‚úÖ Confirmada' : n.status === 'rechazado' ? '‚úó Rechazada' : `üìÖ ${n.expected_visit}`
    return `<div class="ni"><div class="ndot ${dotClass}"></div><div class="ni-body"><div class="ni-txt"><strong>${n.customer_name}</strong> viene por <strong>${prodTitle}</strong></div><div class="ni-meta">${statusText} ¬∑ @${vendName}</div></div>${actions}</div>`
  }).join('')
}

// FIX 1: loadProducts now handles errors and shows proper feedback
async function loadProducts() {
  const list = document.getElementById('productList')
  list.innerHTML = '<div class="empty-state">Cargando productos...</div>'

  const { data, error } = await sb
    .from('products')
    .select('*')
    .eq('comercio_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(10)

  if (error) {
    console.error('Error cargando productos:', error)
    list.innerHTML = `<div class="empty-state">Error al cargar productos: ${error.message}</div>`
    return
  }

  if (!data || data.length === 0) {
    list.innerHTML = '<div class="empty-state">No tienes productos. ¬°Agrega el primero!</div>'
    return
  }

  list.innerHTML = data.map(p => {
    const imgHtml = p.image_url
      ? `<img src="${p.image_url}" alt="${p.title}">`
      : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="1.5" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8"/></svg>`
    return `
    <div class="pr">
      <div class="pimg">${imgHtml}</div>
      <div><div class="pname">${p.title}</div><div class="psub">${p.sales_count || 0} ventas</div></div>
      <div class="pprice">$${(p.retail_price || 0).toLocaleString()}</div>
      <div class="pcomm">+$${(p.commission || 0).toLocaleString()}</div>
      <div><span class="pill ${p.active ? 'pon' : 'poff'}">${p.active ? '‚óè Activo' : 'Inactivo'}</span></div>
      <div class="pacts">
        <button class="ibtn" onclick="deleteProduct('${p.id}')" title="Eliminar">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg>
        </button>
      </div>
    </div>`
  }).join('')
}

async function confirmNotif(id) {
  const { data: notif } = await sb.from('notifications').select('*, products(commission)').eq('id', id).single()
  await sb.from('notifications').update({ status: 'confirmado', confirmed_at: new Date().toISOString() }).eq('id', id)
  await sb.from('sales').insert({
    notification_id: id, product_id: notif.product_id,
    vendedor_id: notif.vendedor_id, comercio_id: notif.comercio_id,
    sale_amount: notif.products?.commission || 0,
    commission_amount: notif.products?.commission || 0, commission_paid: false
  })
  loadNotifications(); loadStats()
}

async function rejectNotif(id) {
  await sb.from('notifications').update({ status: 'rechazado' }).eq('id', id)
  loadNotifications()
}

async function deleteProduct(id) {
  if (!confirm('¬øEliminar este producto?')) return
  await sb.from('products').update({ active: false }).eq('id', id)
  loadProducts(); loadStats()
}

function updateCommission() {
  const retail = parseFloat(document.getElementById('p-retail').value) || 0
  const wholesale = parseFloat(document.getElementById('p-wholesale').value) || 0
  const comm = retail - wholesale
  document.getElementById('commPreview').innerHTML = `Comisi√≥n para el vendedor: <strong>${comm > 0 ? '$' + comm.toLocaleString() : '‚Äî'}</strong>`
}

// FIX 3: File handling functions
function handleFileSelect(input) {
  const file = input.files[0]
  if (!file) return

  // Validate size (5MB)
  if (file.size > 5 * 1024 * 1024) {
    showPhotoError('La imagen no puede ser mayor a 5MB')
    input.value = ''
    return
  }
  // Validate type
  if (!file.type.startsWith('image/')) {
    showPhotoError('Por favor selecciona un archivo de imagen v√°lido')
    input.value = ''
    return
  }

  selectedFile = file
  hidePhotoError()

  const reader = new FileReader()
  reader.onload = (e) => {
    document.getElementById('filePreviewImg').src = e.target.result
    document.getElementById('fileName').textContent = file.name
    document.getElementById('uploadPlaceholder').style.display = 'none'
    document.getElementById('filePreviewContainer').style.display = 'block'
  }
  reader.readAsDataURL(file)
}

function removeFile(e) {
  e.stopPropagation()
  e.preventDefault()
  selectedFile = null
  document.getElementById('p-photo').value = ''
  document.getElementById('filePreviewImg').src = ''
  document.getElementById('fileName').textContent = ''
  document.getElementById('uploadPlaceholder').style.display = 'block'
  document.getElementById('filePreviewContainer').style.display = 'none'
}

function showPhotoError(msg) {
  const el = document.getElementById('photoError')
  el.textContent = msg
  el.style.display = 'block'
}
function hidePhotoError() {
  document.getElementById('photoError').style.display = 'none'
}

async function uploadPhoto(file) {
  const ext = file.name.split('.').pop()
  const fileName = `${currentUser.id}/${Date.now()}.${ext}`

  // Show progress bar
  const progressEl = document.getElementById('uploadProgress')
  const progressBar = document.getElementById('uploadProgressBar')
  progressEl.style.display = 'block'
  progressBar.style.width = '30%'

  const { data, error } = await sb.storage
    .from('product-images')
    .upload(fileName, file, { cacheControl: '3600', upsert: false })

  progressBar.style.width = '100%'

  if (error) {
    progressEl.style.display = 'none'
    throw new Error('Error al subir la imagen: ' + error.message)
  }

  const { data: { publicUrl } } = sb.storage.from('product-images').getPublicUrl(fileName)
  return publicUrl
}

// FIX 1 + 3: saveProduct with proper error handling and photo upload
async function saveProduct() {
  const title = document.getElementById('p-title').value.trim()
  const desc = document.getElementById('p-desc').value.trim()
  const retail = parseFloat(document.getElementById('p-retail').value)
  const wholesale = parseFloat(document.getElementById('p-wholesale').value)
  const payment = document.getElementById('p-payment').value

  const errEl = document.getElementById('saveError')
  errEl.textContent = ''

  if (!title || !retail || !wholesale) { errEl.textContent = 'Llena todos los campos obligatorios.'; return }
  if (retail <= wholesale) { errEl.textContent = 'El precio al p√∫blico debe ser mayor al costo.'; return }

  const btn = document.getElementById('saveProductBtn')
  btn.disabled = true
  btn.innerHTML = '<span class="loading-spinner"></span>Publicando...'

  try {
    // Upload photo if selected
    let imageUrl = null
    if (selectedFile) {
      btn.innerHTML = '<span class="loading-spinner"></span>Subiendo foto...'
      imageUrl = await uploadPhoto(selectedFile)
    }

    btn.innerHTML = '<span class="loading-spinner"></span>Guardando...'

    const { data, error } = await sb.from('products').insert({
      comercio_id: currentUser.id,
      title,
      description: desc,
      retail_price: retail,
      wholesale_price: wholesale,
      commission: retail - wholesale,
      commission_payment_type: payment,
      image_url: imageUrl,
      active: true,
      views: 0,
      sales_count: 0
    }).select()  // <-- FIX: .select() ensures we get the inserted row back

    if (error) {
      console.error('Error al guardar producto:', error)
      errEl.textContent = `Error: ${error.message}`
      btn.disabled = false
      btn.textContent = 'Publicar producto'
      return
    }

    // Success
    closeModal()
    await loadProducts()  // FIX 1: Reload product list after successful save
    await loadStats()

  } catch (err) {
    console.error(err)
    errEl.textContent = err.message || 'Ocurri√≥ un error inesperado.'
    btn.disabled = false
    btn.textContent = 'Publicar producto'
  }
}

function openModal() {
  // Reset form
  document.getElementById('p-title').value = ''
  document.getElementById('p-desc').value = ''
  document.getElementById('p-retail').value = ''
  document.getElementById('p-wholesale').value = ''
  document.getElementById('saveError').textContent = ''
  document.getElementById('uploadProgress').style.display = 'none'
  document.getElementById('uploadProgressBar').style.width = '0%'
  removeFile({ stopPropagation: () => {}, preventDefault: () => {} })
  selectedFile = null
  document.getElementById('saveProductBtn').disabled = false
  document.getElementById('saveProductBtn').textContent = 'Publicar producto'
  document.getElementById('commPreview').innerHTML = 'Comisi√≥n para el vendedor: <strong>$‚Äî</strong>'
  document.getElementById('productModal').classList.add('open')
}

function closeModal() {
  document.getElementById('productModal').classList.remove('open')
}

async function handleLogout() {
  await sb.auth.signOut()
  window.location.href = 'login.html'
}

init()
</script>
</body>
</html>
