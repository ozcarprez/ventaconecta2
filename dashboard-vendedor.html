<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VentaConecta ‚Äî Dashboard Vendedor</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--blue:#1a56ff;--blue-light:#4d7aff;--green:#00d68f;--yellow:#ffcc00;--red:#ff4d6d;--dark:#070b14;--dark-2:#0f1623;--dark-3:#1a2235;--card-bg:rgba(255,255,255,0.035);--border:rgba(255,255,255,0.07);--text:#eef2ff;--muted:rgba(238,242,255,0.45);}
body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);display:flex;min-height:100vh;}
.sidebar{width:248px;min-height:100vh;background:var(--dark-2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-head{padding:24px 24px 20px;border-bottom:1px solid var(--border);}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;background:linear-gradient(120deg,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:16px;}
.sb-user{display:flex;align-items:center;gap:10px;}
.sb-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--green),#00b37a);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;color:#000;flex-shrink:0;}
.sb-name{font-size:13px;font-weight:500;}
.sb-role{font-size:11px;color:var(--muted);}
.sb-nav{padding:16px 0;flex:1;}
.sb-section{padding:12px 20px 6px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:var(--muted);cursor:pointer;transition:all 0.18s;text-decoration:none;}
.sb-item:hover{color:var(--text);background:rgba(255,255,255,0.03);}
.sb-item.active{color:var(--text);background:rgba(0,214,143,0.08);border-right:2px solid var(--green);}
.sb-foot{padding:16px 20px;border-top:1px solid var(--border);}
.logout-btn{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:color 0.2s;}
.logout-btn:hover{color:var(--red);}
.main{margin-left:248px;flex:1;padding:32px 36px;}
.topbar{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;letter-spacing:-0.7px;margin-bottom:3px;}
.page-sub{font-size:13px;color:var(--muted);}
.btn-cat{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;background:rgba(0,214,143,0.12);border:1px solid rgba(0,214,143,0.25);color:var(--green);font-family:'Syne',sans-serif;font-weight:700;font-size:13.5px;border-radius:12px;cursor:pointer;transition:all 0.2s;text-decoration:none;}
.btn-cat:hover{background:rgba(0,214,143,0.2);transform:translateY(-1px);}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.sc{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:22px;position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent);}
.sc-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.sci-b{background:rgba(26,86,255,0.1);border:1px solid rgba(26,86,255,0.18);}
.sci-g{background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.16);}
.sci-y{background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.16);}
.sc-val{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-1px;margin-bottom:3px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.vb{background:linear-gradient(135deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vg{background:linear-gradient(135deg,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vy{background:linear-gradient(135deg,#fff,var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.cobrar{background:linear-gradient(135deg,rgba(255,204,0,0.08),rgba(255,204,0,0.04));border:1px solid rgba(255,204,0,0.22);border-radius:16px;padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;}
.cb-left{display:flex;align-items:center;gap:16px;}
.cb-icon{width:44px;height:44px;border-radius:12px;background:rgba(255,204,0,0.12);border:1px solid rgba(255,204,0,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cb-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--yellow);margin-bottom:3px;}
.cb-sub{font-size:12px;color:var(--muted);}
.cb-amount{font-family:'Syne',sans-serif;font-weight:800;font-size:30px;letter-spacing:-1px;color:var(--yellow);}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;}
.pi{display:flex;align-items:center;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);}
.pi:last-child{border-bottom:none;}
.pi-icon{width:38px;height:38px;border-radius:10px;background:var(--dark-3);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.pi-icon img{width:100%;height:100%;object-fit:cover;}
.pi-info{flex:1;}
.pi-name{font-size:13px;font-weight:500;margin-bottom:2px;}
.pi-meta{font-size:11px;color:var(--muted);}
.pi-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:100px;font-size:11px;font-weight:500;}
.pw{background:rgba(255,204,0,0.08);color:var(--yellow);border:1px solid rgba(255,204,0,0.18);}
.pg{background:rgba(0,214,143,0.08);color:var(--green);border:1px solid rgba(0,214,143,0.16);}
.pi-comm{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--green);}
.hi{display:flex;align-items:center;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);}
.hi:last-child{border-bottom:none;}
.hi-icon{width:36px;height:36px;border-radius:9px;background:var(--dark-3);display:flex;align-items:center;justify-content:center;}
.hi-info{flex:1;}
.hi-name{font-size:13px;font-weight:500;margin-bottom:2px;}
.hi-meta{font-size:11px;color:var(--muted);}
.hi-right{text-align:right;}
.hi-amount{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--green);}
.hi-date{font-size:11px;color:var(--muted);margin-top:2px;}
.empty-state{padding:28px 22px;text-align:center;color:var(--muted);font-size:13px;}
.error-state{padding:28px 22px;text-align:center;color:var(--red);font-size:12px;}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-head">
    <div class="sb-logo">VentaConecta</div>
    <div class="sb-user">
      <div class="sb-avatar" id="userInitials">?</div>
      <div><div class="sb-name" id="userName">Cargando...</div><div class="sb-role">Vendedor</div></div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Principal</div>
    <a class="sb-item active">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>
    <a class="sb-item" href="catalogo.html">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      Cat√°logo
    </a>
    <a class="sb-item">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Mis ganancias
    </a>
  </nav>
  <div class="sb-foot">
    <button class="logout-btn" onclick="handleLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Cerrar sesi√≥n
    </button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="greeting">¬°Hola! üöÄ</div>
      <div class="page-sub" id="dateStr">Cargando...</div>
    </div>
    <a href="catalogo.html" class="btn-cat">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      Ver cat√°logo
    </a>
  </div>

  <div class="stats">
    <div class="sc"><div class="sc-icon sci-b"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="2" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div><div class="sc-val vb" id="stat-enviados">‚Äî</div><div class="sc-lbl">Clientes enviados</div></div>
    <div class="sc"><div class="sc-icon sci-g"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div><div class="sc-val vg" id="stat-confirmadas">‚Äî</div><div class="sc-lbl">Ventas confirmadas</div></div>
    <div class="sc"><div class="sc-icon sci-g"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="sc-val vg" id="stat-ganadas">‚Äî</div><div class="sc-lbl">Comisiones ganadas</div></div>
    <div class="sc" style="border-color:rgba(255,204,0,0.18);"><div class="sc-icon sci-y"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="sc-val vy" id="stat-cobrar">‚Äî</div><div class="sc-lbl">Por cobrar</div></div>
  </div>

  <div class="cobrar" id="cobrarBanner" style="display:none;">
    <div class="cb-left">
      <div class="cb-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="1.8" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
      <div><div class="cb-title">Tienes comisiones por cobrar</div><div class="cb-sub" id="cobrarSub"></div></div>
    </div>
    <div class="cb-amount" id="cobrarAmount">$0</div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="card-head"><div class="card-title">Pendientes</div></div>
      <div id="pendingList"><div class="empty-state">Cargando...</div></div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">Historial de ganancias</div></div>
      <div id="historyList"><div class="empty-state">Cargando...</div></div>
    </div>
  </div>
</main>

<script>
const SUPABASE_URL = 'https://miiitegvpxoplanszido.supabase.co'
const SUPABASE_KEY = 'sb_publishable_uONmieVhZiope7XWhMnFHA_gQbIHF2w'
const { createClient } = supabase
const sb = createClient(SUPABASE_URL, SUPABASE_KEY)

let currentUser = null

async function init() {
  const { data: { user } } = await sb.auth.getUser()
  if (!user) { window.location.href = 'login.html'; return }
  currentUser = user

  const { data: profile } = await sb.from('users').select('*').eq('id', user.id).single()
  if (!profile || profile.user_type !== 'vendedor') { window.location.href = 'login.html'; return }

  const name = profile.full_name || profile.email
  document.getElementById('userName').textContent = name
  document.getElementById('userInitials').textContent = name.substring(0, 2).toUpperCase()
  document.getElementById('greeting').textContent = `¬°Hola, ${name.split(' ')[0]}! üöÄ`
  const now = new Date()
  document.getElementById('dateStr').textContent = now.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })

  loadStats()
  loadPending()
  loadHistory()
}

async function loadStats() {
  const uid = currentUser.id
  const [notifs, confirmed, sales, unpaid] = await Promise.all([
    sb.from('notifications').select('id', { count: 'exact', head: true }).eq('vendedor_id', uid),
    sb.from('notifications').select('id', { count: 'exact', head: true }).eq('vendedor_id', uid).eq('status', 'confirmado'),
    sb.from('sales').select('commission_amount').eq('vendedor_id', uid),
    sb.from('sales').select('commission_amount').eq('vendedor_id', uid).eq('commission_paid', false)
  ])

  document.getElementById('stat-enviados').textContent = notifs.count || 0
  document.getElementById('stat-confirmadas').textContent = confirmed.count || 0

  const total = (sales.data || []).reduce((s, r) => s + (r.commission_amount || 0), 0)
  document.getElementById('stat-ganadas').textContent = '$' + total.toLocaleString()

  const porCobrar = (unpaid.data || []).reduce((s, r) => s + (r.commission_amount || 0), 0)
  document.getElementById('stat-cobrar').textContent = '$' + porCobrar.toLocaleString()

  if (porCobrar > 0) {
    document.getElementById('cobrarBanner').style.display = 'flex'
    document.getElementById('cobrarAmount').textContent = '$' + porCobrar.toLocaleString()
    document.getElementById('cobrarSub').textContent = `${unpaid.data?.length} ventas confirmadas ¬∑ visita los comercios para cobrar`
  }
}

async function loadPending() {
  const list = document.getElementById('pendingList')

  // Fetch notifications first
  const { data: notifs, error } = await sb
    .from('notifications')
    .select('*')
    .eq('vendedor_id', currentUser.id)
    .eq('status', 'enviado')
    .order('created_at', { ascending: false })
    .limit(10)

  if (error) {
    list.innerHTML = `<div class="error-state">Error al cargar pendientes: ${error.message}</div>`
    return
  }

  if (!notifs || notifs.length === 0) {
    list.innerHTML = '<div class="empty-state">No tienes clientes pendientes</div>'
    return
  }

  // Fetch related products and comercios separately (robust fallback)
  const productIds = [...new Set(notifs.map(n => n.product_id).filter(Boolean))]
  const comercioIds = [...new Set(notifs.map(n => n.comercio_id).filter(Boolean))]

  const [prodsRes, comerciosRes] = await Promise.all([
    productIds.length > 0 ? sb.from('products').select('id, title, commission, image_url').in('id', productIds) : { data: [] },
    comercioIds.length > 0 ? sb.from('users').select('id, business_name').in('id', comercioIds) : { data: [] }
  ])

  const prodMap = {}
  ;(prodsRes.data || []).forEach(p => { prodMap[p.id] = p })
  const comercioMap = {}
  ;(comerciosRes.data || []).forEach(c => { comercioMap[c.id] = c })

  list.innerHTML = notifs.map(n => {
    const prod = prodMap[n.product_id] || {}
    const comercio = comercioMap[n.comercio_id] || {}
    const imgHtml = prod.image_url
      ? `<img src="${prod.image_url}" alt="${prod.title}">`
      : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="1.5" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8"/></svg>`
    return `
    <div class="pi">
      <div class="pi-icon">${imgHtml}</div>
      <div class="pi-info">
        <div class="pi-name">${prod.title || 'Producto'}</div>
        <div class="pi-meta">${n.customer_name} ¬∑ ${comercio.business_name || 'Comercio'} ¬∑ ${n.expected_visit || ''}</div>
      </div>
      <div class="pi-right">
        <span class="pill pw">‚è≥ Esperando</span>
        <div class="pi-comm">+$${(prod.commission || 0).toLocaleString()}</div>
      </div>
    </div>`
  }).join('')
}

async function loadHistory() {
  const list = document.getElementById('historyList')

  const { data: sales, error } = await sb
    .from('sales')
    .select('*')
    .eq('vendedor_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(10)

  if (error) {
    list.innerHTML = `<div class="error-state">Error al cargar historial: ${error.message}</div>`
    return
  }

  if (!sales || sales.length === 0) {
    list.innerHTML = '<div class="empty-state">No tienes ventas a√∫n. ¬°Ve al cat√°logo!</div>'
    return
  }

  // Fetch products and comercios separately
  const productIds = [...new Set(sales.map(s => s.product_id).filter(Boolean))]
  const comercioIds = [...new Set(sales.map(s => s.comercio_id).filter(Boolean))]

  const [prodsRes, comerciosRes] = await Promise.all([
    productIds.length > 0 ? sb.from('products').select('id, title').in('id', productIds) : { data: [] },
    comercioIds.length > 0 ? sb.from('users').select('id, business_name').in('id', comercioIds) : { data: [] }
  ])

  const prodMap = {}
  ;(prodsRes.data || []).forEach(p => { prodMap[p.id] = p })
  const comercioMap = {}
  ;(comerciosRes.data || []).forEach(c => { comercioMap[c.id] = c })

  list.innerHTML = sales.map(s => {
    const prod = prodMap[s.product_id] || {}
    const comercio = comercioMap[s.comercio_id] || {}
    const paidBadge = s.commission_paid
      ? '<span class="pill pg">‚úì Cobrada</span>'
      : '<span class="pill pw">‚è≥ Por cobrar</span>'
    return `
    <div class="hi">
      <div class="hi-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="1.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="hi-info">
        <div class="hi-name">${prod.title || 'Producto'}</div>
        <div class="hi-meta">${comercio.business_name || 'Comercio'} ¬∑ ${paidBadge}</div>
      </div>
      <div class="hi-right">
        <div class="hi-amount">+$${(s.commission_amount || 0).toLocaleString()}</div>
        <div class="hi-date">${new Date(s.created_at).toLocaleDateString('es-MX')}</div>
      </div>
    </div>`
  }).join('')
}

async function handleLogout() {
  await sb.auth.signOut()
  window.location.href = 'login.html'
}

init()
</script>
</body>
</html>
