<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VentaConecta ‚Äî Dashboard Vendedor</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--blue:#1a56ff;--blue-light:#4d7aff;--green:#00d68f;--yellow:#ffcc00;--red:#ff4d6d;--dark:#070b14;--dark-2:#0f1623;--dark-3:#1a2235;--card-bg:rgba(255,255,255,0.035);--border:rgba(255,255,255,0.07);--text:#eef2ff;--muted:rgba(238,242,255,0.45);}
body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);display:flex;min-height:100vh;}
.sidebar{width:248px;min-height:100vh;background:var(--dark-2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-head{padding:24px 24px 20px;border-bottom:1px solid var(--border);}
.sb-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;background:linear-gradient(120deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:16px;}
.sb-user{display:flex;align-items:center;gap:10px;}
.sb-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue-light));display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;color:#fff;flex-shrink:0;}
.sb-name{font-size:13px;font-weight:500;}.sb-role{font-size:11px;color:var(--muted);}
.sb-nav{padding:16px 0;flex:1;}
.sb-section{padding:12px 20px 6px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:var(--muted);cursor:pointer;transition:all 0.18s;text-decoration:none;}
.sb-item:hover{color:var(--text);background:rgba(255,255,255,0.03);}
.sb-item.active{color:var(--text);background:rgba(26,86,255,0.1);border-right:2px solid var(--blue);}
.sb-foot{padding:16px 20px;border-top:1px solid var(--border);}
.logout-btn{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:color 0.2s;}
.logout-btn:hover{color:var(--red);}
.main{margin-left:248px;flex:1;padding:32px 36px;}
.topbar{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;letter-spacing:-0.7px;margin-bottom:3px;}
.page-sub{font-size:13px;color:var(--muted);}
.btn-catalog{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:13.5px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;text-decoration:none;}
.btn-catalog:hover{background:var(--blue-light);transform:translateY(-1px);box-shadow:0 8px 28px rgba(26,86,255,0.4);}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.sc{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:22px;}
.sc-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.sci-b{background:rgba(26,86,255,0.1);border:1px solid rgba(26,86,255,0.18);}
.sci-g{background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.16);}
.sci-y{background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.16);}
.sci-r{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.16);}
.sc-val{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-1px;margin-bottom:3px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.vb{background:linear-gradient(135deg,#fff,var(--blue-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vg{background:linear-gradient(135deg,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vy{background:linear-gradient(135deg,#fff,var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.vr{background:linear-gradient(135deg,#fff,#ff8fa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.card-full{background:var(--card-bg);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;}
.btn-see-catalog{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;background:rgba(26,86,255,0.08);border:1px solid rgba(26,86,255,0.2);color:var(--blue-light);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;transition:all 0.18s;}
.btn-see-catalog:hover{background:rgba(26,86,255,0.15);}
/* Pending items */
.pi{display:flex;align-items:flex-start;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);transition:background 0.18s;}
.pi:last-child{border-bottom:none;}
.pi:hover{background:rgba(255,255,255,0.02);}
.pidot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.dy{background:var(--yellow);box-shadow:0 0 8px rgba(255,204,0,0.5);}
.dg{background:var(--green);}
.db{background:var(--blue-light);box-shadow:0 0 8px rgba(77,122,255,0.5);}
.dr{background:var(--red);}
.pi-body{flex:1;}
.pi-txt{font-size:13px;line-height:1.5;margin-bottom:3px;}
.pi-meta{font-size:11px;color:var(--muted);}
.pi-acts{display:flex;gap:6px;flex-shrink:0;align-items:flex-start;padding-top:1px;}
.bchat{padding:5px 11px;background:rgba(77,122,255,0.1);border:1px solid rgba(77,122,255,0.25);color:var(--blue-light);border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;transition:all 0.18s;}
.bchat:hover{background:rgba(77,122,255,0.2);}
.step-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:10px;font-weight:600;}
.step-1{background:rgba(255,204,0,0.1);color:var(--yellow);border:1px solid rgba(255,204,0,0.2);}
.step-2{background:rgba(77,122,255,0.1);color:var(--blue-light);border:1px solid rgba(77,122,255,0.2);}
.step-3{background:rgba(0,214,143,0.1);color:var(--green);border:1px solid rgba(0,214,143,0.2);}
/* History */
.hi{display:flex;align-items:center;gap:12px;padding:11px 22px;border-bottom:1px solid var(--border);}
.hi:last-child{border-bottom:none;}
.hi-dot{width:26px;height:26px;border-radius:8px;background:rgba(0,214,143,0.1);border:1px solid rgba(0,214,143,0.18);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.hi-body{flex:1;}
.hi-prod{font-size:13px;font-weight:500;margin-bottom:1px;}
.hi-meta{font-size:11px;color:var(--muted);}
.hi-comm{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--green);margin-left:auto;flex-shrink:0;}
.hi-status{font-size:10px;font-weight:600;padding:2px 8px;border-radius:100px;margin-left:8px;}
.hs-cobrar{background:rgba(255,204,0,0.1);color:var(--yellow);border:1px solid rgba(255,204,0,0.2);}
.hs-pagado{background:rgba(0,214,143,0.08);color:var(--green);border:1px solid rgba(0,214,143,0.18);}
/* Mis productos */
.my-prod-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;padding:16px 22px;}
.my-prod-card{background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:14px;overflow:hidden;position:relative;}
.my-prod-img{width:100%;height:120px;background:var(--dark-3);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.my-prod-img img{width:100%;height:100%;object-fit:cover;}
.my-prod-body{padding:10px 12px;}
.my-prod-title{font-size:12px;font-weight:600;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.my-prod-comm{font-size:11px;color:var(--green);font-family:'Syne',sans-serif;font-weight:700;}
.my-prod-biz{font-size:10px;color:var(--muted);margin-top:1px;}
.btn-tiene-cliente{width:100%;margin-top:8px;padding:6px;background:rgba(255,204,0,0.08);border:1px solid rgba(255,204,0,0.2);color:var(--yellow);border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;font-family:'Syne',sans-serif;}
.btn-tiene-cliente:hover{background:rgba(255,204,0,0.15);}
.btn-quitar{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:6px;background:rgba(0,0,0,0.5);border:1px solid var(--border);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all 0.18s;}
.btn-quitar:hover{background:rgba(255,77,109,0.2);color:var(--red);}
/* chat */
.chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);z-index:300;display:none;align-items:center;justify-content:center;}
.chat-overlay.open{display:flex;}
.chat-box{background:var(--dark-2);border:1px solid var(--border);border-radius:24px;width:440px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;}
.chat-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0;}
.chat-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;}
.chat-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.chat-close{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;min-height:200px;max-height:380px;}
.chat-messages::-webkit-scrollbar{width:4px;}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.msg{display:flex;flex-direction:column;max-width:78%;}
.msg.mine{align-self:flex-end;align-items:flex-end;}
.msg.theirs{align-self:flex-start;align-items:flex-start;}
.msg-sender{font-size:10px;color:var(--muted);margin-bottom:3px;font-weight:500;}
.msg-bubble{padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.45;}
.msg.mine .msg-bubble{background:rgba(26,86,255,0.25);border:1px solid rgba(26,86,255,0.3);border-bottom-right-radius:4px;}
.msg.theirs .msg-bubble{background:rgba(255,255,255,0.06);border:1px solid var(--border);border-bottom-left-radius:4px;}
.msg-time{font-size:10px;color:var(--muted);margin-top:3px;}
.chat-success-banner{margin:0 16px 12px;padding:10px 14px;background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.2);border-radius:12px;font-size:12px;color:var(--green);display:none;flex-shrink:0;}
.chat-input-row{display:flex;gap:8px;padding:14px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.chat-input{flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;resize:none;}
.chat-input:focus{border-color:rgba(26,86,255,0.4);}
.chat-send-btn{width:38px;height:38px;border-radius:10px;background:var(--blue);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.18s;}
.chat-send-btn:hover{background:var(--blue-light);}
.chat-empty{text-align:center;color:var(--muted);font-size:12px;padding:24px;}
/* Client modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.client-modal{background:var(--dark-2);border:1px solid var(--border);border-radius:24px;width:100%;max-width:420px;padding:32px;position:relative;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px;display:block;}
.form-input{width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:rgba(255,204,0,0.4);}
.form-input::placeholder{color:var(--muted);}
.btn-modal-y{width:100%;padding:13px;background:var(--yellow);color:#000;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.btn-modal-y:hover{background:#ffe033;}
.modal-close2{position:absolute;top:16px;right:16px;width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;}
.loading-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.3);border-top-color:#000;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty-state{padding:28px 22px;text-align:center;color:var(--muted);font-size:13px;}
.cobrar-banner{background:rgba(255,204,0,0.06);border:1px solid rgba(255,204,0,0.15);border-radius:16px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;}
.cobrar-banner-text{font-size:13px;color:var(--yellow);}
.cobrar-amount{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:var(--yellow);}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-head">
    <div class="sb-logo">VentaConecta</div>
    <div class="sb-user">
      <div class="sb-avatar" id="userInitials">?</div>
      <div><div class="sb-name" id="userName">Cargando...</div><div class="sb-role">Vendedor</div></div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Principal</div>
    <a class="sb-item active">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </a>
    <a class="sb-item" href="catalogo.html">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      Cat√°logo
    </a>
    <a class="sb-item">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Mis ganancias
    </a>
  </nav>
  <div class="sb-foot">
    <button class="logout-btn" onclick="handleLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Cerrar sesi√≥n
    </button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="greeting">¬°Hola! üöÄ</div>
      <div class="page-sub" id="dateStr">Cargando...</div>
    </div>
    <a class="btn-catalog" href="catalogo.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      Ver cat√°logo
    </a>
  </div>

  <div id="cobrarBanner" style="display:none;" class="cobrar-banner">
    <div><div class="cobrar-banner-text">üí∞ Tienes comisiones por cobrar</div><div style="font-size:11px;color:var(--muted);" id="cobrarSub"></div></div>
    <div class="cobrar-amount" id="cobrarTotal">$0</div>
  </div>

  <div class="stats">
    <div class="sc"><div class="sc-icon sci-b"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="2" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div><div class="sc-val vb" id="stat-enviados">‚Äî</div><div class="sc-lbl">Clientes enviados</div></div>
    <div class="sc"><div class="sc-icon sci-g"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div><div class="sc-val vg" id="stat-ventas">‚Äî</div><div class="sc-lbl">Ventas confirmadas</div></div>
    <div class="sc"><div class="sc-icon sci-y"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="sc-val vy" id="stat-comisiones">‚Äî</div><div class="sc-lbl">Comisiones ganadas</div></div>
    <div class="sc"><div class="sc-icon sci-r"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff8fa3" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="sc-val vr" id="stat-cobrar">‚Äî</div><div class="sc-lbl">Por cobrar</div></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="card-head"><div class="card-title">Pendientes</div></div>
      <div id="pendingList"><div class="empty-state">Cargando...</div></div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">Historial de ganancias</div></div>
      <div id="historyList"><div class="empty-state">Cargando...</div></div>
    </div>
  </div>

  <!-- MIS PRODUCTOS -->
  <div class="card-full">
    <div class="card-head">
      <div class="card-title">üõçÔ∏è Mis productos <span style="font-size:11px;font-weight:400;color:var(--muted);">‚Äî Los que est√°s ofreciendo ahora</span></div>
      <a class="btn-see-catalog" href="catalogo.html">+ Agregar producto</a>
    </div>
    <div id="myProductsList"><div class="empty-state">No est√°s ofreciendo ning√∫n producto a√∫n. <a href="catalogo.html" style="color:var(--blue-light);">Explora el cat√°logo ‚Üí</a></div></div>
  </div>
</main>

<!-- CHAT MODAL -->
<div class="chat-overlay" id="chatOverlay">
  <div class="chat-box">
    <div class="chat-head">
      <div><div class="chat-title" id="chatTitle">Chat</div><div class="chat-sub" id="chatSub">Coordinando visita</div></div>
      <button class="chat-close" onclick="closeChat()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="chat-messages" id="chatMessages"><div class="chat-empty">Cargando...</div></div>
    <div class="chat-success-banner" id="chatSuccessBanner">üéâ ¬°Venta confirmada! La comisi√≥n fue activada.</div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." rows="1" onkeydown="handleChatKey(event)"></textarea>
      <button class="chat-send-btn" onclick="sendMessage()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    </div>
  </div>
</div>

<!-- CLIENT MODAL -->
<div class="modal-overlay" id="clientModal">
  <div class="client-modal">
    <button class="modal-close2" onclick="closeClientModal()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:17px;margin-bottom:4px;">üì¢ Tengo un cliente</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Notifica al comercio que alguien viene a comprar</div>
    <div class="form-group"><label class="form-label">Nombre del cliente</label><input class="form-input" type="text" id="c-name" placeholder="Ej. Mar√≠a Gonz√°lez"></div>
    <div class="form-group"><label class="form-label">Cu√°ndo visita (opcional)</label><input class="form-input" type="text" id="c-visit" placeholder="Ej. Hoy a las 4pm, Ma√±ana"></div>
    <div class="form-group"><label class="form-label">Nota adicional (opcional)</label><input class="form-input" type="text" id="c-note" placeholder="Talla, color, cantidad..."></div>
    <div style="color:var(--red);font-size:12px;margin-bottom:8px;display:none;" id="clientError"></div>
    <button class="btn-modal-y" id="sendNotifBtn" onclick="sendNotification()">Enviar notificaci√≥n al comercio</button>
  </div>
</div>

<script>
const SUPABASE_URL='https://miiitegvpxoplanszido.supabase.co'
const SUPABASE_KEY='sb_publishable_uONmieVhZiope7XWhMnFHA_gQbIHF2w'
const {createClient}=supabase
const sb=createClient(SUPABASE_URL,SUPABASE_KEY)
let currentUser=null,currentProfile=null
let chatNotifId=null,chatChannel=null
let activeProductForClient=null,activeComercioForClient=null

async function init(){
  const {data:{user}}=await sb.auth.getUser()
  if(!user){window.location.href='login.html';return}
  currentUser=user
  const {data:profile}=await sb.from('users').select('*').eq('id',user.id).single()
  if(!profile||profile.user_type!=='vendedor'){window.location.href='login.html';return}
  currentProfile=profile
  const name=profile.full_name||profile.email
  document.getElementById('userName').textContent=name
  document.getElementById('userInitials').textContent=name.substring(0,2).toUpperCase()
  document.getElementById('greeting').textContent=`¬°Hola, ${name.split(' ')[0]}! üöÄ`
  const now=new Date()
  document.getElementById('dateStr').textContent=now.toLocaleDateString('es-MX',{weekday:'long',year:'numeric',month:'long',day:'numeric'})
  loadStats();loadPending();loadHistory();loadMyProducts()
  subscribeRealtime()
}

async function loadStats(){
  const uid=currentUser.id
  const [notifs,sales,cobrar]=await Promise.all([
    sb.from('notifications').select('id',{count:'exact',head:true}).eq('vendedor_id',uid),
    sb.from('sales').select('id',{count:'exact',head:true}).eq('vendedor_id',uid),
    sb.from('sales').select('commission_amount').eq('vendedor_id',uid).eq('commission_paid',false)
  ])
  document.getElementById('stat-enviados').textContent=notifs.count||0
  document.getElementById('stat-ventas').textContent=sales.count||0
  const total=(cobrar.data||[]).reduce((s,r)=>s+(r.commission_amount||0),0)
  const {data:pagadas}=await sb.from('sales').select('commission_amount').eq('vendedor_id',uid).eq('commission_paid',true)
  const totalPagadas=(pagadas||[]).reduce((s,r)=>s+(r.commission_amount||0),0)
  document.getElementById('stat-comisiones').textContent='$'+totalPagadas.toLocaleString()
  document.getElementById('stat-cobrar').textContent='$'+total.toLocaleString()
  if(total>0){
    const cnt=cobrar.data?.length||0
    document.getElementById('cobrarBanner').style.display='flex'
    document.getElementById('cobrarSub').textContent=`${cnt} venta${cnt>1?'s':''} ¬∑ visita los comercios para cobrar`
    document.getElementById('cobrarTotal').textContent='$'+total.toLocaleString()
  }else{
    document.getElementById('cobrarBanner').style.display='none'
  }
}

async function loadPending(){
  const {data}=await sb.from('notifications')
    .select('*, products(title,commission), users!comercio_id(business_name,email)')
    .eq('vendedor_id',currentUser.id).in('status',['enviado','recibido']).order('created_at',{ascending:false})
  const list=document.getElementById('pendingList')
  if(!data||data.length===0){list.innerHTML='<div class="empty-state">No tienes clientes pendientes</div>';return}
  list.innerHTML=data.map(n=>{
    const biz=n.users?.business_name||n.users?.email||'comercio'
    const prod=n.products?.title||'producto'
    const comm=n.products?.commission||0
    let dotClass,badge,acts
    if(n.status==='enviado'){
      dotClass='dy';badge='<span class="step-badge step-1">‚è≥ Esperando acuse</span>';acts=''
    }else{
      dotClass='db';badge='<span class="step-badge step-2">üí¨ Chat abierto</span>'
      const sp=encodeURIComponent(prod),sb2=encodeURIComponent(biz)
      acts=`<div class="pi-acts"><button class="bchat" onclick="openChat('${n.id}','${sp}','${sb2}')">Abrir chat</button></div>`
    }
    return `<div class="pi"><div class="pidot ${dotClass}"></div><div class="pi-body"><div class="pi-txt"><strong>${n.customer_name}</strong> ‚Üí <strong>${prod}</strong></div><div class="pi-meta">${badge} ¬∑ ${biz} ¬∑ +$${comm}</div></div>${acts}</div>`
  }).join('')
}

async function loadHistory(){
  const {data}=await sb.from('sales')
    .select('*, products(title), users!comercio_id(business_name,email)')
    .eq('vendedor_id',currentUser.id).order('created_at',{ascending:false}).limit(8)
  const list=document.getElementById('historyList')
  if(!data||data.length===0){list.innerHTML='<div class="empty-state">Sin historial a√∫n</div>';return}
  list.innerHTML=data.map(s=>{
    const biz=s.users?.business_name||s.users?.email||'comercio'
    const prod=s.products?.title||'producto'
    const date=new Date(s.created_at).toLocaleDateString('es-MX',{day:'numeric',month:'short',year:'numeric'})
    return `<div class="hi"><div class="hi-dot"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#00d68f" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div><div class="hi-body"><div class="hi-prod">${prod}</div><div class="hi-meta">${biz} ¬∑ ${date}</div></div><div style="display:flex;align-items:center;"><span class="hi-comm">+$${(s.commission_amount||0).toLocaleString()}</span><span class="hi-status ${s.commission_paid?'hs-pagado':'hs-cobrar'}">${s.commission_paid?'Pagado':'Por cobrar'}</span></div></div>`
  }).join('')
}

async function loadMyProducts(){
  const {data:vp}=await sb.from('vendor_products')
    .select('*, products(*, users!comercio_id(business_name,email))')
    .eq('vendedor_id',currentUser.id).order('created_at',{ascending:false})
  const list=document.getElementById('myProductsList')
  if(!vp||vp.length===0){
    list.innerHTML='<div class="empty-state">No est√°s ofreciendo ning√∫n producto a√∫n. <a href="catalogo.html" style="color:var(--blue-light);">Explora el cat√°logo ‚Üí</a></div>'
    return
  }
  list.innerHTML=`<div class="my-prod-grid">${vp.map(v=>{
    const p=v.products;if(!p)return''
    const biz=p.users?.business_name||p.users?.email||'comercio'
    const imgHtml=p.image_url?`<img src="${p.image_url}" alt="${p.title}">`:`<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#4d7aff" stroke-width="1" stroke-linecap="round" style="opacity:0.3;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`
    return `<div class="my-prod-card">
      <div class="my-prod-img">${imgHtml}</div>
      <button class="btn-quitar" onclick="quitarProducto('${p.id}')">√ó</button>
      <div class="my-prod-body">
        <div class="my-prod-title">${p.title}</div>
        <div class="my-prod-comm">+$${(p.commission||0).toLocaleString()}</div>
        <div class="my-prod-biz">${biz}</div>
        <button class="btn-tiene-cliente" onclick="openClientForProduct('${p.id}','${p.comercio_id}')">üì¢ Tengo un cliente</button>
      </div>
    </div>`
  }).join('')}</div>`
}

async function quitarProducto(productId){
  if(!confirm('¬øDejar de ofrecer este producto?'))return
  await sb.from('vendor_products').delete().eq('vendedor_id',currentUser.id).eq('product_id',productId)
  loadMyProducts()
}

function openClientForProduct(productId,comercioId){
  activeProductForClient=productId;activeComercioForClient=comercioId
  document.getElementById('c-name').value=''
  document.getElementById('c-visit').value=''
  document.getElementById('c-note').value=''
  document.getElementById('clientError').style.display='none'
  document.getElementById('clientModal').classList.add('open')
}
function closeClientModal(){document.getElementById('clientModal').classList.remove('open')}

async function sendNotification(){
  const name=document.getElementById('c-name').value.trim()
  const visit=document.getElementById('c-visit').value.trim()
  const note=document.getElementById('c-note').value.trim()
  const errEl=document.getElementById('clientError')
  if(!name){errEl.textContent='Escribe el nombre del cliente.';errEl.style.display='block';return}
  const btn=document.getElementById('sendNotifBtn');btn.disabled=true;btn.innerHTML='<span class="loading-spinner"></span>Enviando...'
  const {error}=await sb.from('notifications').insert({
    vendedor_id:currentUser.id,comercio_id:activeComercioForClient,product_id:activeProductForClient,
    customer_name:name,expected_visit:visit,notes:note,status:'enviado'
  })
  btn.disabled=false;btn.textContent='Enviar notificaci√≥n al comercio'
  if(error){errEl.textContent=error.message;errEl.style.display='block';return}
  closeClientModal()
  loadPending();loadStats()
}

// CHAT
function openChat(notifId,sp,sb2){
  chatNotifId=notifId
  document.getElementById('chatTitle').textContent=`Chat ¬∑ ${decodeURIComponent(sp)}`
  document.getElementById('chatSub').textContent=`Con ${decodeURIComponent(sb2)}`
  document.getElementById('chatSuccessBanner').style.display='none'
  document.getElementById('chatOverlay').classList.add('open')
  document.getElementById('chatInput').value=''
  loadMessages();subscribeToChat()
}
async function loadMessages(){
  const container=document.getElementById('chatMessages')
  const {data,error}=await sb.from('messages').select('*, users!sender_id(full_name,business_name,email)').eq('notification_id',chatNotifId).order('created_at',{ascending:true})
  if(error||!data||data.length===0){container.innerHTML='<div class="chat-empty">üí¨ Sin mensajes a√∫n</div>';return}
  container.innerHTML=data.map(msg=>{
    const isMine=msg.sender_id===currentUser.id
    const name=msg.users?.full_name||msg.users?.business_name||msg.users?.email||'?'
    const time=new Date(msg.created_at).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})
    return `<div class="msg ${isMine?'mine':'theirs'}"><div class="msg-sender">${isMine?'T√∫':name}</div><div class="msg-bubble">${msg.text}</div><div class="msg-time">${time}</div></div>`
  }).join('')
  container.scrollTop=container.scrollHeight
}
function subscribeToChat(){
  if(chatChannel){sb.removeChannel(chatChannel);chatChannel=null}
  chatChannel=sb.channel('chat-v-'+chatNotifId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`notification_id=eq.${chatNotifId}`},()=>loadMessages())
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'notifications',filter:`id=eq.${chatNotifId}`},(payload)=>{
      if(payload.new?.status==='vendido'){
        document.getElementById('chatSuccessBanner').style.display='block'
        loadStats();loadPending();loadHistory()
      }
    })
    .subscribe()
}
async function sendMessage(){
  const text=document.getElementById('chatInput').value.trim()
  if(!text||!chatNotifId)return
  document.getElementById('chatInput').value=''
  await sb.from('messages').insert({notification_id:chatNotifId,sender_id:currentUser.id,text})
}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}}
function closeChat(){
  document.getElementById('chatOverlay').classList.remove('open')
  if(chatChannel){sb.removeChannel(chatChannel);chatChannel=null}
  chatNotifId=null
}
function subscribeRealtime(){
  sb.channel('vendor-notifs-'+currentUser.id).on('postgres_changes',{event:'*',schema:'public',table:'notifications',filter:`vendedor_id=eq.${currentUser.id}`},()=>{loadPending();loadStats()}).subscribe()
  sb.channel('vendor-vp-'+currentUser.id).on('postgres_changes',{event:'*',schema:'public',table:'vendor_products',filter:`vendedor_id=eq.${currentUser.id}`},()=>{loadMyProducts()}).subscribe()
}
async function handleLogout(){await sb.auth.signOut();window.location.href='login.html'}
init()
</script>
</body>
</html>
